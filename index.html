import tkinter as tk
import customtkinter as ctk
from tkinter import filedialog, messagebox
import requests
import json
import os
import re

# C·∫•u h√¨nh giao di·ªán m·∫∑c ƒë·ªãnh
ctk.set_appearance_mode("Dark")
ctk.set_default_color_theme("blue")

class SolaMaster(ctk.CTk):
    def __init__(self):
        super().__init__()

        self.title("SOLA MASTER - Desktop Pro v5.0")
        self.geometry("1100x700")
        
        # State
        self.api_key = self.load_config("api_key", "")
        self.app_id = "sola_master_desktop"
        
        # Grid layout
        self.grid_columnconfigure(1, weight=1)
        self.grid_rowconfigure(0, weight=1)

        # Sidebar
        self.sidebar = ctk.CTkFrame(self, width=240, corner_radius=0)
        self.sidebar.grid(row=0, column=0, sticky="nsew")
        self.sidebar.grid_rowconfigure(6, weight=1)

        self.logo_label = ctk.CTkLabel(self.sidebar, text="SOLA MASTER", font=ctk.CTkFont(family="Cinzel", size=24, weight="bold"))
        self.logo_label.grid(row=0, column=0, px=20, py=(20, 10))
        
        self.sub_logo = ctk.CTkLabel(self.sidebar, text="UNIVERSAL INTERFACE", text_color="#4facfe", font=ctk.CTkFont(size=10, weight="bold"))
        self.sub_logo.grid(row=1, column=0, px=20, py=(0, 20))

        # Navigation Buttons
        self.btn_home = ctk.CTkButton(self.sidebar, text="ü™Ñ D·ªãch Thu·∫≠t", corner_radius=10, height=40, fg_color="transparent", text_color=("gray10", "gray90"), hover_color=("gray70", "gray30"), anchor="w", command=lambda: self.select_page("home"))
        self.btn_home.grid(row=2, column=0, px=20, py=5)

        self.btn_analyze = ctk.CTkButton(self.sidebar, text="üìú VƒÉn H·ªçc", corner_radius=10, height=40, fg_color="transparent", text_color=("gray10", "gray90"), hover_color=("gray70", "gray30"), anchor="w", command=lambda: self.select_page("analyze"))
        self.btn_analyze.grid(row=3, column=0, px=20, py=5)

        self.btn_epub = ctk.CTkButton(self.sidebar, text="üìñ C·ªï Th∆∞ EPUB", corner_radius=10, height=40, fg_color="transparent", text_color=("gray10", "gray90"), hover_color=("gray70", "gray30"), anchor="w", command=lambda: self.select_page("epub"))
        self.btn_epub.grid(row=4, column=0, px=20, py=5)

        self.btn_purify = ctk.CTkButton(self.sidebar, text="üßπ Thanh T·∫©y", corner_radius=10, height=40, fg_color="transparent", text_color=("gray10", "gray90"), hover_color=("gray70", "gray30"), anchor="w", command=lambda: self.select_page("purify"))
        self.btn_purify.grid(row=5, column=0, px=20, py=5)

        # Bottom Sidebar Buttons
        self.btn_settings = ctk.CTkButton(self.sidebar, text="‚öôÔ∏è C√†i ƒê·∫∑t", corner_radius=10, fg_color="transparent", text_color=("gray10", "gray90"), hover_color=("gray70", "gray30"), anchor="w", command=lambda: self.select_page("settings"))
        self.btn_settings.grid(row=7, column=0, px=20, py=5)

        self.btn_refresh = ctk.CTkButton(self.sidebar, text="üîÑ L√†m M·ªõi", corner_radius=10, fg_color="transparent", text_color="orange", anchor="w", command=self.refresh_app)
        self.btn_refresh.grid(row=8, column=0, px=20, py=5)

        self.btn_fullscreen = ctk.CTkButton(self.sidebar, text="üì∫ To√†n M√†n H√¨nh", corner_radius=10, fg_color="transparent", text_color="cyan", anchor="w", command=self.toggle_fullscreen)
        self.btn_fullscreen.grid(row=9, column=0, px=20, py=(5, 20))

        # --- PAGES ---
        self.container = ctk.CTkFrame(self, fg_color="transparent")
        self.container.grid(row=0, column=1, sticky="nsew", px=20, py=20)
        self.container.grid_columnconfigure(0, weight=1)
        self.container.grid_rowconfigure(0, weight=1)

        self.pages = {}
        self.init_home()
        self.init_analyze()
        self.init_epub()
        self.init_purify()
        self.init_settings()

        self.select_page("home")

    def init_home(self):
        page = ctk.CTkFrame(self.container, fg_color="transparent")
        self.pages["home"] = page
        
        header = ctk.CTkLabel(page, text="MA PH√ÅP D·ªäCH THU·∫¨T", font=ctk.CTkFont(family="Cinzel", size=20, weight="bold"))
        header.pack(pady=10)

        # Controls
        ctrl_frame = ctk.CTkFrame(page, fg_color="transparent")
        ctrl_frame.pack(fill="x", pady=5)
        
        self.home_src = ctk.CTkOptionMenu(ctrl_frame, values=["Ti·∫øng Nh·∫≠t", "Ti·∫øng Trung", "Ti·∫øng Anh", "T·ª± ƒë·ªông"])
        self.home_src.pack(side="left", px=5)
        
        self.home_dest = ctk.CTkOptionMenu(ctrl_frame, values=["Ti·∫øng Vi·ªát", "Ti·∫øng Anh"])
        self.home_dest.pack(side="left", px=5)
        
        self.home_prompt = ctk.CTkEntry(ctrl_frame, placeholder_text="B·ªëi c·∫£nh (v√≠d·ª•: Light Novel l·∫°nh l√πng...)", width=400)
        self.home_prompt.pack(side="left", fill="x", expand=True, px=5)

        # Text Area
        text_frame = ctk.CTkFrame(page, fg_color="transparent")
        text_frame.pack(fill="both", expand=True, pady=10)
        text_frame.grid_columnconfigure((0,1), weight=1)
        text_frame.grid_rowconfigure(0, weight=1)

        self.home_input = ctk.CTkTextbox(text_frame, font=("Quicksand", 16))
        self.home_input.grid(row=0, column=0, sticky="nsew", px=5)
        
        self.home_output = ctk.CTkTextbox(text_frame, font=("Quicksand", 16), text_color="#ffd700")
        self.home_output.grid(row=0, column=1, sticky="nsew", px=5)

        self.btn_run_home = ctk.CTkButton(page, text="KHAI TRI·ªÇN MA PH√ÅP", height=50, fg_color="#ffd700", text_color="black", font=ctk.CTkFont(weight="bold"), command=lambda: self.run_gemini("home"))
        self.btn_run_home.pack(fill="x", pady=10)

    def init_analyze(self):
        page = ctk.CTkFrame(self.container, fg_color="transparent")
        self.pages["analyze"] = page
        
        ctk.CTkLabel(page, text="GI·∫¢I M√É VƒÇN CH∆Ø∆†NG", font=ctk.CTkFont(family="Cinzel", size=20, weight="bold", text_color="orange")).pack(pady=10)
        
        text_frame = ctk.CTkFrame(page, fg_color="transparent")
        text_frame.pack(fill="both", expand=True, pady=10)
        text_frame.grid_columnconfigure((0,1), weight=1)
        text_frame.grid_rowconfigure(0, weight=1)

        self.analyze_input = ctk.CTkTextbox(text_frame, font=("Quicksand", 16))
        self.analyze_input.grid(row=0, column=0, sticky="nsew", px=5)
        
        self.analyze_output = ctk.CTkTextbox(text_frame, font=("Quicksand", 16), text_color="#4facfe", italic=True)
        self.analyze_output.grid(row=0, column=1, sticky="nsew", px=5)

        ctk.CTkButton(page, text="SOI S√ÅNG C·∫¢M X√öC", height=50, fg_color="#4facfe", command=lambda: self.run_gemini("analyze")).pack(fill="x", pady=10)

    def init_epub(self):
        page = ctk.CTkFrame(self.container, fg_color="transparent")
        self.pages["epub"] = page
        
        header_frame = ctk.CTkFrame(page, fg_color="transparent")
        header_frame.pack(fill="x", pady=10)
        ctk.CTkLabel(header_frame, text="TH∆Ø VI·ªÜN C·ªî TH∆Ø", font=ctk.CTkFont(family="Cinzel", size=20, weight="bold")).pack(side="left")
        
        self.epub_src = ctk.CTkOptionMenu(header_frame, values=["Ti·∫øng Nh·∫≠t", "Ti·∫øng Trung"], width=100)
        self.epub_src.pack(side="right", px=5)

        ctrl = ctk.CTkFrame(page, fg_color="transparent")
        ctrl.pack(fill="x", pady=5)
        ctk.CTkButton(ctrl, text="N·∫†P EPUB/TXT", command=self.load_file_epub).pack(side="left", px=5)
        self.epub_prompt = ctk.CTkEntry(ctrl, placeholder_text="B·ªëi c·∫£nh d·ªãch...", width=500)
        self.epub_prompt.pack(side="left", fill="x", expand=True, px=5)

        self.epub_view = ctk.CTkTextbox(page, font=("Serif", 14), text_color="gray80")
        self.epub_view.pack(fill="both", expand=True, pady=10)

        ctk.CTkButton(page, text="D·ªäCH TO√ÄN CH∆Ø∆†NG", height=50, fg_color="#ffd700", text_color="black", command=lambda: self.run_gemini("epub")).pack(fill="x", pady=10)

    def init_purify(self):
        page = ctk.CTkFrame(self.container, fg_color="transparent")
        self.pages["purify"] = page
        
        ctk.CTkLabel(page, text="H·ªí THANH T·∫®Y", font=ctk.CTkFont(family="Cinzel", size=20, weight="bold")).pack(pady=10)
        
        ctrl = ctk.CTkFrame(page, fg_color="transparent")
        ctrl.pack(fill="x", pady=5)
        ctk.CTkButton(ctrl, text="N·∫†P FILE R√ÅC", command=self.load_file_clean).pack(side="left", px=5)
        ctk.CTkButton(ctrl, text="D·ªåN S·∫†CH", fg_color="red", command=lambda: self.clean_text.delete("1.0", "end")).pack(side="left", px=5)

        self.clean_text = ctk.CTkTextbox(page, font=("Quicksand", 14))
        self.clean_text.pack(fill="both", expand=True, pady=10)

        btn_grid = ctk.CTkFrame(page, fg_color="transparent")
        btn_grid.pack(fill="x")
        ctk.CTkButton(btn_grid, text="L·ªçc Nh·∫≠t", command=lambda: self.run_purify("ja")).pack(side="left", expand=True, px=5)
        ctk.CTkButton(btn_grid, text="L·ªçc Trung", command=lambda: self.run_purify("zh")).pack(side="left", expand=True, px=5)
        ctk.CTkButton(btn_grid, text="L·ªçc H√†n", command=lambda: self.run_purify("ko")).pack(side="left", expand=True, px=5)
        ctk.CTkButton(btn_grid, text="L·ªçc Anh", command=lambda: self.run_purify("en")).pack(side="left", expand=True, px=5)

    def init_settings(self):
        page = ctk.CTkFrame(self.container, fg_color="transparent")
        self.pages["settings"] = page
        
        ctk.CTkLabel(page, text="C·∫§U H√åNH H·ªÜ TH·ªêNG", font=ctk.CTkFont(family="Cinzel", size=24, weight="bold", text_color="#ffd700")).pack(pady=40)
        
        self.api_entry = ctk.CTkEntry(page, placeholder_text="D√°n Gemini API Key t·∫°i ƒë√¢y...", width=500, height=50, show="*")
        self.api_entry.pack(pady=10)
        if self.api_key: self.api_entry.insert(0, self.api_key)

        ctk.CTkButton(page, text="L∆ØU C·∫§U H√åNH", width=300, height=50, fg_color="#4facfe", command=self.save_settings).pack(pady=20)

    # --- LOGIC ---
    def select_page(self, name):
        for page in self.pages.values():
            page.pack_forget()
        self.pages[name].pack(fill="both", expand=True)
        
        # Highlight btn
        btns = {"home": self.btn_home, "analyze": self.btn_analyze, "epub": self.btn_epub, "purify": self.btn_purify, "settings": self.btn_settings}
        for k, v in btns.items():
            v.configure(fg_color="transparent" if k != name else ("gray75", "gray25"))

    def load_config(self, key, default):
        try:
            if os.path.exists("config.json"):
                with open("config.json", "r") as f:
                    return json.load(f).get(key, default)
        except: pass
        return default

    def save_settings(self):
        self.api_key = self.api_entry.get().strip()
        with open("config.json", "w") as f:
            json.dump({"api_key": self.api_key}, f)
        messagebox.showinfo("Th√†nh c√¥ng", "ƒê√£ l∆∞u API Key v√†o h·ªá th·ªëng!")

    def load_file_epub(self):
        path = filedialog.askopenfilename(filetypes=[("Text files", "*.txt")])
        if path:
            with open(path, "r", encoding="utf-8") as f:
                self.epub_view.delete("1.0", "end")
                self.epub_view.insert("1.0", f.read())

    def load_file_clean(self):
        path = filedialog.askopenfilename(filetypes=[("Text files", "*.txt")])
        if path:
            with open(path, "r", encoding="utf-8") as f:
                self.clean_text.delete("1.0", "end")
                self.clean_text.insert("1.0", f.read())

    def run_purify(self, lang):
        text = self.clean_text.get("1.0", "end")
        if lang == "ja": pattern = r'[\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF\s\d.,!?"\'()\-:;]'
        elif lang == "zh": pattern = r'[\u4E00-\u9FFF\s\d.,!?"\'()\-:;]'
        elif lang == "ko": pattern = r'[\uAC00-\uD7AF\s\d.,!?"\'()\-:;]'
        else: pattern = r'[a-zA-Z\s\d.,!?"\'()\-:;]'
        
        cleaned = "".join(re.findall(pattern, text))
        self.clean_text.delete("1.0", "end")
        self.clean_text.insert("1.0", cleaned)

    def run_gemini(self, mode):
        if not self.api_key:
            messagebox.showwarning("Thi·∫øu Key", "Vui l√≤ng v√†o C√†i ƒë·∫∑t ƒë·ªÉ nh·∫≠p API Key!")
            return self.select_page("settings")

        input_data = ""
        sys_prompt = ""
        output_widget = None

        if mode == "home":
            input_data = self.home_input.get("1.0", "end").strip()
            output_widget = self.home_output
            sys_prompt = f"D·ªãch t·ª´ {self.home_src.get()} sang {self.home_dest.get()}. Y√™u c·∫ßu: {self.home_prompt.get()}. Kh√¥ng d√πng d·∫•u sao (*) trong k·∫øt qu·∫£."
        elif mode == "analyze":
            input_data = self.analyze_input.get("1.0", "end").strip()
            output_widget = self.analyze_output
            sys_prompt = "Ph√¢n t√≠ch t√¢m tr·∫°ng nh√¢n v·∫≠t v√† d·ªãch hoa m·ªπ sang ti·∫øng Vi·ªát. Kh√¥ng d√πng d·∫•u sao (*)."
        elif mode == "epub":
            input_data = self.epub_view.get("1.0", "end").strip()
            output_widget = self.epub_view
            sys_prompt = f"D·ªãch n·ªôi dung ch∆∞∆°ng t·ª´ {self.epub_src.get()} sang ti·∫øng Vi·ªát. B·ªëi c·∫£nh: {self.epub_prompt.get()}. Kh√¥ng d√πng d·∫•u sao (*)."

        if not input_data: return

        # Request call
        url = f"https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key={self.api_key}"
        headers = {'Content-Type': 'application/json'}
        payload = {
            "contents": [{"parts": [{"text": input_data[:20000]}]}],
            "systemInstruction": {"parts": [{"text": sys_prompt}]}
        }

        try:
            response = requests.post(url, headers=headers, json=payload, timeout=30)
            data = response.json()
            result = data['candidates'][0]['content']['parts'][0]['text']
            output_widget.delete("1.0", "end")
            output_widget.insert("1.0", result)
        except Exception as e:
            messagebox.showerror("L·ªói", f"Kh√¥ng th·ªÉ k·∫øt n·ªëi API: {str(e)}")

    def toggle_fullscreen(self):
        is_full = self.attributes("-fullscreen")
        self.attributes("-fullscreen", not is_full)

    def refresh_app(self):
        self.destroy()
        os.system("python sola_master.py")

if __name__ == "__main__":
    app = SolaMaster()
    app.mainloop()
