<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SOLA Master Pro v3 - Full Fixed</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'magi-dark': '#0f0c29',
                        'magi-purple': '#302b63',
                        'accent-gold': '#ffd700',
                        'accent-cyan': '#00f2ff'
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        serif: ['Playfair Display', 'serif'],
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: #e0e0e0;
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            height: 100vh;
        }

        .glass-panel {
            background: rgba(20, 20, 40, 0.75);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .glass-input {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
        }

        .tab-content { display: none; height: 100%; }
        .tab-content.active { display: flex; flex-direction: column; }

        .nav-item.active {
            background: linear-gradient(90deg, rgba(255,215,0,0.1), transparent);
            border-left: 3px solid #ffd700;
            color: #ffd700;
        }

        .magic-spinner {
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-left-color: #00f2ff;
            border-radius: 50%;
            width: 24px; height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: rgba(255,215,0,0.3); border-radius: 10px; }
    </style>
</head>
<body class="flex flex-col">

    <!-- Header -->
    <header class="glass-panel h-14 flex items-center justify-between px-6 z-20 shrink-0">
        <div class="flex items-center gap-3">
            <i class="fa-solid fa-dragon text-accent-gold text-2xl animate-pulse"></i>
            <h1 class="font-serif text-xl font-bold tracking-wider">SOLA <span class="text-accent-cyan">MASTER PRO v3</span></h1>
        </div>
        <div class="flex items-center gap-4">
            <button onclick="toggleFullscreen()" class="hover:text-accent-cyan"><i class="fa-solid fa-expand"></i></button>
            <div id="api-status" class="text-[10px] px-2 py-1 rounded border border-red-500/50 text-red-400">OFFLINE</div>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        
        <!-- Sidebar -->
        <nav class="glass-panel w-16 md:w-64 flex flex-col py-4 z-10 shrink-0 border-r border-white/5">
            <div class="flex-1 space-y-1">
                <button onclick="switchTab('tab-translate')" id="btn-tab-translate" class="nav-item active w-full text-left px-4 py-3 flex items-center gap-3"><i class="fa-solid fa-wand-magic-sparkles w-6 text-center"></i><span class="hidden md:block">Ma Pháp Dịch</span></button>
                <button onclick="switchTab('tab-epub')" id="btn-tab-epub" class="nav-item w-full text-left px-4 py-3 flex items-center gap-3"><i class="fa-solid fa-book-journal-whills w-6 text-center"></i><span class="hidden md:block">Thư Viện Cổ Thư</span></button>
                <button onclick="switchTab('tab-analyze')" id="btn-tab-analyze" class="nav-item w-full text-left px-4 py-3 flex items-center gap-3"><i class="fa-solid fa-magnifying-glass-chart w-6 text-center"></i><span class="hidden md:block">Giải Mã</span></button>
                <button onclick="switchTab('tab-cleaner')" id="btn-tab-cleaner" class="nav-item w-full text-left px-4 py-3 flex items-center gap-3"><i class="fa-solid fa-broom w-6 text-center"></i><span class="hidden md:block">Hồ Thanh Tẩy</span></button>
            </div>
            <button onclick="switchTab('tab-settings')" id="btn-tab-settings" class="nav-item w-full text-left px-4 py-3 flex items-center gap-3 mt-auto border-t border-white/10"><i class="fa-solid fa-gears w-6 text-center"></i><span class="hidden md:block">Cấu Hình</span></button>
        </nav>

        <!-- Main -->
        <main class="flex-1 p-4 relative overflow-hidden">
            
            <!-- 1. TRANSLATE -->
            <div id="tab-translate" class="tab-content active gap-4">
                <div class="glass-panel p-4 rounded-lg flex flex-col gap-3 shrink-0">
                    <div class="flex justify-between items-center">
                        <label class="text-accent-gold font-serif">Chế độ Dịch</label>
                        <select id="trans-style" class="glass-input px-3 py-1 rounded text-sm w-48">
                            <option value="Tự nhiên, trôi chảy, văn phong Light Novel">Light Novel</option>
                            <option value="Hán Việt, cổ trang, kiếm hiệp">Kiếm Hiệp</option>
                            <option value="Lãng mạn, nhẹ nhàng, ngôn tình">Ngôn Tình</option>
                        </select>
                    </div>
                    <input type="text" id="custom-prompt" placeholder="Lời nhắc riêng cho AI..." class="glass-input w-full px-3 py-2 rounded text-sm">
                </div>
                <div class="flex-1 flex gap-4 min-h-0">
                    <textarea id="trans-input" class="glass-input flex-1 p-4 rounded-lg resize-none font-mono text-sm" placeholder="Văn bản gốc..."></textarea>
                    <div class="flex flex-col justify-center"><button onclick="executeMagic('translate')" class="w-12 h-12 rounded-full bg-blue-600 flex items-center justify-center shadow-lg"><i class="fa-solid fa-bolt"></i></button></div>
                    <div class="flex-1 relative">
                        <textarea id="trans-output" class="glass-input w-full h-full p-4 rounded-lg resize-none" readonly placeholder="Kết quả..."></textarea>
                        <div id="loading-trans" class="absolute inset-0 bg-black/50 flex items-center justify-center hidden rounded-lg"><div class="magic-spinner"></div></div>
                    </div>
                </div>
            </div>

            <!-- 2. EPUB READER -->
            <div id="tab-epub" class="tab-content gap-4">
                <div class="glass-panel p-3 rounded-lg flex flex-wrap items-center gap-4 shrink-0">
                    <label class="cursor-pointer bg-white/10 px-3 py-2 rounded text-xs font-bold border border-white/10">
                        NẠP FILE <input type="file" id="file-upload" accept=".epub,.txt" class="hidden" onchange="handleFileUpload(this)">
                    </label>
                    <input type="text" id="epub-custom-prompt" class="glass-input flex-1 px-3 py-2 rounded text-sm" placeholder="Prompt dịch chương (VD: Dịch giọng lạnh lùng, giữ Hán Việt...)">
                    <div class="flex gap-2">
                        <button onclick="translateCurrentChapter()" class="px-3 py-2 bg-indigo-600 rounded text-xs font-bold">DỊCH CHƯƠNG</button>
                        <button onclick="toggleAutoTranslate()" id="btn-auto-trans" class="px-3 py-2 bg-emerald-700 rounded text-xs font-bold">AUTO BULK</button>
                    </div>
                </div>
                <div class="flex-1 flex gap-4 min-h-0 overflow-hidden">
                    <div id="chapter-list" class="w-56 glass-panel overflow-y-auto p-2 text-xs space-y-1"></div>
                    <div class="flex-1 flex flex-col gap-2">
                        <div class="flex justify-between items-center text-accent-cyan px-2">
                            <button onclick="navChapter(-1)"><i class="fa-solid fa-chevron-left"></i></button>
                            <span id="current-chapter-title" class="font-bold truncate">Tiêu đề</span>
                            <button onclick="navChapter(1)"><i class="fa-solid fa-chevron-right"></i></button>
                        </div>
                        <div class="flex-1 flex gap-2 min-h-0">
                            <div id="reader-raw" class="flex-1 glass-panel p-6 overflow-y-auto text-sm leading-relaxed whitespace-pre-wrap"></div>
                            <div class="flex-1 glass-panel p-6 overflow-y-auto text-sm leading-relaxed text-emerald-50 whitespace-pre-wrap relative">
                                <div id="reader-trans"></div>
                                <div id="bulk-status" class="absolute top-2 right-2 text-[10px] text-emerald-400 hidden animate-pulse">Auto running...</div>
                                <div id="loading-reader" class="absolute inset-0 bg-black/60 flex items-center justify-center hidden"><div class="magic-spinner"></div></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 3. ANALYZE -->
            <div id="tab-analyze" class="tab-content gap-4">
                <div class="glass-panel p-6 rounded-lg max-w-4xl mx-auto w-full flex flex-col h-full">
                    <h2 class="text-xl font-serif text-accent-gold mb-4 italic">Giải Mã Văn Chương</h2>
                    <textarea id="analyze-input" class="glass-input w-full h-32 p-4 rounded-lg mb-4" placeholder="Nhập từ khó hoặc đoạn văn cần giải nghĩa..."></textarea>
                    <button onclick="executeMagic('analyze')" class="bg-purple-600 py-3 rounded-lg font-bold mb-4">PHÂN TÍCH LINH KHÍ</button>
                    <div id="analyze-output" class="flex-1 bg-black/20 rounded-lg p-6 overflow-y-auto text-sm leading-relaxed hidden"></div>
                    <div id="loading-analyze" class="hidden text-center py-10"><div class="magic-spinner mx-auto"></div></div>
                </div>
            </div>

            <!-- 4. CLEANER -->
            <div id="tab-cleaner" class="tab-content gap-4">
                <div class="glass-panel p-4 rounded-lg flex flex-wrap gap-4 items-center justify-between">
                    <label class="cursor-pointer bg-red-900/30 px-3 py-2 rounded text-xs border border-red-500/30">
                        NẠP RÁC (.epub/.txt) <input type="file" id="cleaner-upload" accept=".epub,.txt" class="hidden" onchange="handleCleanerFile(this)">
                    </label>
                    <div class="flex gap-2">
                        <button onclick="cleanText('html')" class="px-3 py-1 bg-white/10 rounded text-xs">Xóa HTML</button>
                        <button onclick="cleanText('zh')" class="px-3 py-1 bg-yellow-900/40 rounded text-xs">Lọc Trung</button>
                        <button onclick="cleanText('ja')" class="px-3 py-1 bg-pink-900/40 rounded text-xs">Lọc Nhật</button>
                        <button onclick="cleanText('space')" class="px-3 py-1 bg-blue-900/40 rounded text-xs">Cách dòng</button>
                    </div>
                </div>
                <div class="flex-1 flex gap-4 min-h-0">
                    <textarea id="cleaner-input" class="glass-input flex-1 p-4 rounded-lg text-xs font-mono" placeholder="Rác đầu vào..."></textarea>
                    <textarea id="cleaner-output" class="glass-input flex-1 p-4 rounded-lg text-xs font-mono" placeholder="Sạch đầu ra..."></textarea>
                </div>
            </div>

            <!-- 5. SETTINGS -->
            <div id="tab-settings" class="tab-content items-center justify-center">
                <div class="glass-panel p-8 rounded-xl w-full max-w-sm space-y-6">
                    <h2 class="text-xl font-bold text-center">CÀI ĐẶT</h2>
                    <div class="space-y-2">
                        <label class="text-xs text-accent-cyan block">Gemini API Key</label>
                        <input type="password" id="api-key-input" class="glass-input w-full px-4 py-2 rounded" placeholder="AIzaSy...">
                    </div>
                    <div class="space-y-2">
                        <label class="text-xs text-gray-300 block">Ảnh Nền</label>
                        <input type="file" id="bg-file-input" accept="image/*" class="hidden" onchange="previewBackground(this)">
                        <button onclick="document.getElementById('bg-file-input').click()" class="w-full py-2 bg-white/10 rounded text-xs">Tải Ảnh Lên</button>
                        <button onclick="removeBackground()" class="w-full text-[10px] text-red-400 underline">Về mặc định</button>
                    </div>
                    <button onclick="saveSettings()" class="w-full py-3 bg-accent-gold text-black font-bold rounded shadow-lg">LƯU CẤU HÌNH</button>
                </div>
            </div>

        </main>
    </div>

    <script>
        const API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent";
        let currentChapterIndex = 0;
        let isAutoTranslating = false;
        let chaptersContent = [];
        let tempBgData = null;

        window.onload = function() {
            loadSettings();
            switchTab('tab-translate');
        };

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            document.getElementById('btn-' + tabId).classList.add('active');
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) document.documentElement.requestFullscreen();
            else document.exitFullscreen();
        }

        // --- Settings ---
        function saveSettings() {
            const key = document.getElementById('api-key-input').value.trim();
            if (key) localStorage.setItem('sola_key', key);
            if (tempBgData) localStorage.setItem('sola_bg', tempBgData);
            updateStatus();
            alert("Đã lưu!");
        }

        function loadSettings() {
            const key = localStorage.getItem('sola_key');
            const bg = localStorage.getItem('sola_bg');
            if (key) document.getElementById('api-key-input').value = key;
            if (bg) document.body.style.backgroundImage = `url('${bg}')`;
            updateStatus();
        }

        function updateStatus() {
            const key = localStorage.getItem('sola_key');
            const el = document.getElementById('api-status');
            el.innerText = key ? "ONLINE" : "OFFLINE";
            el.className = key ? "text-[10px] px-2 py-1 rounded border border-green-500/50 text-green-400" : "text-[10px] px-2 py-1 rounded border border-red-500/50 text-red-400";
        }

        function previewBackground(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = e => {
                    tempBgData = e.target.result;
                    document.body.style.backgroundImage = `url('${e.target.result}')`;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function removeBackground() {
            localStorage.removeItem('sola_bg');
            document.body.style.backgroundImage = "none";
            location.reload();
        }

        // --- Core AI ---
        async function callGemini(sys, txt) {
            const key = localStorage.getItem('sola_key');
            if (!key) return alert("Thiếu API Key!");
            try {
                const res = await fetch(`${API_URL}?key=${key}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: sys + "\n\n" + txt }] }] })
                });
                const data = await res.json();
                return data.candidates[0].content.parts[0].text;
            } catch (e) { return null; }
        }

        async function executeMagic(mode) {
            let input, output, loader, prompt;
            if(mode === 'translate') {
                input = document.getElementById('trans-input').value;
                output = document.getElementById('trans-output');
                loader = document.getElementById('loading-trans');
                const style = document.getElementById('trans-style').value;
                const custom = document.getElementById('custom-prompt').value;
                prompt = `Dịch sang tiếng Việt. Style: ${custom || style}.`;
            } else {
                input = document.getElementById('analyze-input').value;
                output = document.getElementById('analyze-output');
                loader = document.getElementById('loading-analyze');
                prompt = "Giải nghĩa chi tiết đoạn văn sau, lưu ý các điển tích hoặc từ cổ:";
            }
            if(!input) return;
            loader.classList.remove('hidden');
            const res = await callGemini(prompt, input);
            loader.classList.add('hidden');
            if(res) {
                if(mode==='translate') output.value = res;
                else { output.innerHTML = res.replace(/\n/g, '<br>'); output.classList.remove('hidden'); }
            }
        }

        // --- File Handling ---
        async function handleFileUpload(input) {
            const file = input.files[0]; if(!file) return;
            chaptersContent = [];
            if(file.name.endsWith('.txt')) {
                const text = await file.text();
                const parts = text.split(/(Chương \d+|Chapter \d+|Hồi \d+|Quyển \d+)/i);
                for(let i=1; i<parts.length; i+=2) chaptersContent.push({title: parts[i], content: parts[i+1]});
                if(chaptersContent.length === 0) chaptersContent.push({title: "Toàn văn", content: text});
            } else {
                const zip = await JSZip.loadAsync(file);
                const entries = [];
                zip.forEach((path, entry) => { if(path.match(/\.(html|xhtml|htm)$/i)) entries.push(entry); });
                entries.sort((a,b)=>a.name.localeCompare(b.name));
                for(let e of entries) {
                    const h = await e.async("string");
                    const doc = new DOMParser().parseFromString(h, 'text/html');
                    chaptersContent.push({ title: doc.querySelector('h1,h2,h3')?.innerText || e.name, content: doc.body.innerText });
                }
            }
            renderChapters();
            loadChapter(0);
        }

        function renderChapters() {
            const list = document.getElementById('chapter-list');
            list.innerHTML = chaptersContent.map((c, i) => `<div onclick="loadChapter(${i})" class="p-2 hover:bg-white/10 rounded cursor-pointer truncate ${i===currentChapterIndex?'text-accent-gold bg-white/5':''}">${c.title}</div>`).join('');
        }

        function loadChapter(i) {
            if(i<0 || i>=chaptersContent.length) return;
            currentChapterIndex = i;
            const c = chaptersContent[i];
            docu
