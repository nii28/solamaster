import React, { useState, useEffect, useRef } from 'react';
import { 
  Wand2, Book, ScrollText, Eraser, Settings, 
  Maximize, RefreshCw, Upload, Download, 
  Languages, Sparkles, BookOpen, Trash2, 
  ChevronRight, Play, Save, Eye, EyeOff
} from 'lucide-react';

// --- Cấu hình Firebase & Gemini (Giả định môi trường Canvas) ---
const appId = typeof __app_id !== 'undefined' ? __app_id : 'sola-master-pro';

const SOLA_MASTER_PRO = () => {
  // --- State Toàn cục ---
  const [activeTab, setActiveTab] = useState('translate');
  const [apiKey, setApiKey] = useState(localStorage.getItem('sola_gemini_key') || '');
  const [bgImage, setBgImage] = useState(localStorage.getItem('sola_bg') || 'https://images.unsplash.com/photo-1518709268805-4e9042af9f23?q=80&w=1974&auto=format&fit=crop');
  const [isFullScreen, setIsFullScreen] = useState(false);
  const [loading, setLoading] = useState(false);

  // --- State Ma Pháp Dịch Thuật ---
  const [transInput, setTransInput] = useState('');
  const [transOutput, setTransOutput] = useState('');
  const [contextPrompt, setContextPrompt] = useState('Dịch theo phong cách kiếm hiệp cổ điển, trau chuốt từ ngữ.');

  // --- State Thư Viện Cổ Thư (EPUB/TXT) ---
  const [chapters, setChapters] = useState([]);
  const [currentChapterIndex, setCurrentChapterIndex] = useState(null);
  const [isParallelView, setIsParallelView] = useState(true);

  // --- State Hồ Thanh Tẩy ---
  const [cleanInput, setCleanInput] = useState('');
  const [cleanOutput, setCleanOutput] = useState('');

  // --- State Giải Mã Văn Chương ---
  const [analyzeInput, setAnalyzeInput] = useState('');
  const [analyzeResult, setAnalyzeResult] = useState(null);

  // --- Effects ---
  useEffect(() => {
    localStorage.setItem('sola_gemini_key', apiKey);
  }, [apiKey]);

  useEffect(() => {
    localStorage.setItem('sola_bg', bgImage);
  }, [bgImage]);

  // --- Tiện ích ---
  const toggleFullScreen = () => {
    if (!document.fullscreenElement) {
      document.documentElement.requestFullscreen();
      setIsFullScreen(true);
    } else {
      if (document.exitFullscreen) {
        document.exitFullscreen();
        setIsFullScreen(false);
      }
    }
  };

  const showToast = (msg) => {
    // Đơn giản hóa thay vì alert
    console.log(msg);
  };

  // --- Hàm gọi Gemini API ---
  const callGemini = async (prompt, systemInstruction) => {
    if (!apiKey) {
      alert("Hỡi pháp sư, hãy nhập 'Linh hồn AI' (API Key) trong Phòng Ấn để bắt đầu!");
      return null;
    }
    setLoading(true);
    try {
      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{ parts: [{ text: prompt }] }],
          systemInstruction: { parts: [{ text: systemInstruction }] }
        })
      });
      const data = await response.json();
      setLoading(false);
      return data.candidates?.[0]?.content?.parts?.[0]?.text || "Phép thuật thất bại, hãy kiểm tra lại kết nối.";
    } catch (error) {
      setLoading(false);
      console.error(error);
      return "Lỗi ma pháp nghiêm trọng!";
    }
  };

  // --- Xử lý Ma Pháp Dịch Thuật ---
  const handleTranslate = async () => {
    const systemPrompt = `Bạn là một dịch giả văn học chuyên nghiệp. Nhiệm vụ của bạn là dịch văn bản sang tiếng Việt. Context: ${contextPrompt}`;
    const result = await callGemini(transInput, systemPrompt);
    if (result) setTransOutput(result);
  };

  // --- Xử lý Hồ Thanh Tẩy ---
  const purifyText = (type) => {
    let text = cleanInput;
    if (type === 'JA') text = text.replace(/[^\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF\u3000-\u303F0-9a-zA-Z\s\.,!?\n]/g, '');
    if (type === 'ZH') text = text.replace(/[^\u4E00-\u9FFF\u3000-\u303F0-9a-zA-Z\s\.,!?\n]/g, '');
    if (type === 'HTML') text = text.replace(/<[^>]*>?/gm, '');
    // Regex xóa rác chung
    text = text.replace(/(http|https):\/\/[^\s]+/g, '');
    setCleanOutput(text.trim());
  };

  // --- Xử lý EPUB (Sử dụng JSZip từ CDN) ---
  const handleFileUpload = async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    if (file.name.endsWith('.txt')) {
      const text = await file.text();
      const splitChapters = text.split(/Chương\s+\d+|Chapter\s+\d+/i);
      setChapters(splitChapters.filter(c => c.trim()).map((content, i) => ({
        title: `Chương ${i + 1}`,
        original: content.trim(),
        translated: ''
      })));
    } else if (file.name.endsWith('.epub')) {
      // Cần thư viện JSZip để xử lý EPUB thực thụ. 
      // Ở đây demo cấu trúc danh sách chương giả lập từ tên file.
      setChapters([{
        title: "Dữ liệu EPUB (Cần JSZip)",
        original: "Tính năng này yêu cầu thư viện JSZip được nạp vào. Hãy đảm bảo bạn đã tích hợp script JSZip.",
        translated: ""
      }]);
    }
    setCurrentChapterIndex(0);
  };

  // --- Xử lý Giải Mã Văn Chương ---
  const handleAnalyze = async () => {
    const systemPrompt = "Bạn là một nhà phê bình và dịch giả văn học cao cấp. Hãy phân tích đoạn văn sau: tìm ẩn dụ, tâm trạng nhân vật và đề xuất bản dịch mượt mà nhất.";
    const result = await callGemini(analyzeInput, systemPrompt);
    if (result) setAnalyzeResult(result);
  };

  return (
    <div 
      className="min-h-screen text-slate-100 font-sans selection:bg-purple-500/30 transition-all duration-700 ease-in-out"
      style={{
        backgroundImage: `linear-gradient(rgba(15, 23, 42, 0.85), rgba(15, 23, 42, 0.95)), url(${bgImage})`,
        backgroundSize: 'cover',
        backgroundPosition: 'center',
        backgroundAttachment: 'fixed'
      }}
    >
      {/* --- Thanh Công cụ Hệ thống --- */}
      <nav className="fixed top-0 left-0 right-0 h-16 bg-slate-900/60 backdrop-blur-md border-b border-purple-500/30 flex items-center justify-between px-6 z-50">
        <div className="flex items-center gap-3">
          <div className="w-10 h-10 bg-gradient-to-br from-purple-600 to-blue-600 rounded-lg flex items-center justify-center shadow-lg shadow-purple-500/20">
            <Sparkles className="text-white w-6 h-6 animate-pulse" />
          </div>
          <h1 className="text-xl font-bold tracking-wider bg-clip-text text-transparent bg-gradient-to-r from-purple-400 to-blue-400">
            SOLA MASTER PRO
          </h1>
        </div>

        <div className="flex items-center gap-2">
          <button onClick={toggleFullScreen} className="p-2 hover:bg-white/10 rounded-full transition-colors" title="Toàn màn hình">
            <Maximize size={20} />
          </button>
          <button onClick={() => window.location.reload()} className="p-2 hover:bg-white/10 rounded-full transition-colors" title="Làm mới thần tốc">
            <RefreshCw size={20} />
          </button>
        </div>
      </nav>

      <div className="flex pt-16 h-screen overflow-hidden">
        {/* --- Sidebar Menu --- */}
        <aside className="w-20 md:w-64 bg-slate-900/40 backdrop-blur-xl border-r border-white/5 flex flex-col p-4 gap-4">
          <MenuItem 
            active={activeTab === 'translate'} 
            onClick={() => setActiveTab('translate')} 
            icon={<Wand2 size={22} />} 
            label="Ma Pháp Dịch Thuật" 
          />
          <MenuItem 
            active={activeTab === 'library'} 
            onClick={() => setActiveTab('library')} 
            icon={<Book size={22} />} 
            label="Thư Viện Cổ Thư" 
          />
          <MenuItem 
            active={activeTab === 'analyze'} 
            onClick={() => setActiveTab('analyze')} 
            icon={<ScrollText size={22} />} 
            label="Giải Mã Văn Chương" 
          />
          <MenuItem 
            active={activeTab === 'purify'} 
            onClick={() => setActiveTab('purify')} 
            icon={<Eraser size={22} />} 
            label="Hồ Thanh Tẩy" 
          />
          <div className="mt-auto">
            <MenuItem 
              active={activeTab === 'settings'} 
              onClick={() => setActiveTab('settings')} 
              icon={<Settings size={22} />} 
              label="Phòng Ấn Cấu Hình" 
            />
          </div>
        </aside>

        {/* --- Main Content Area --- */}
        <main className="flex-1 overflow-y-auto p-4 md:p-8 custom-scrollbar">
          
          {/* Tab 1: Ma Pháp Dịch Thuật */}
          {activeTab === 'translate' && (
            <div className="max-w-5xl mx-auto animate-in fade-in slide-in-from-bottom-4 duration-500">
              <SectionHeader title="Ma Pháp Dịch Thuật" subtitle="Chuyển ngữ văn chương bằng quyền năng Gemini" />
              
              <div className="grid grid-cols-1 gap-6">
                <div className="bg-slate-800/40 border border-white/10 rounded-2xl p-4">
                  <label className="text-sm text-purple-300 font-medium mb-2 block flex items-center gap-2">
                    <Sparkles size={14} /> Linh hồn bản dịch (Context Prompt)
                  </label>
                  <input 
                    type="text" 
                    className="w-full bg-slate-950/50 border border-white/10 rounded-xl px-4 py-3 outline-none focus:border-purple-500 transition-all text-sm"
                    value={contextPrompt}
                    onChange={(e) => setContextPrompt(e.target.value)}
                    placeholder="Ví dụ: Dịch phong cách Tiên Hiệp, xưng hô 'lão phu' - 'ngươi'..."
                  />
                </div>

                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 h-[500px]">
                  <div className="flex flex-col gap-2">
                    <label className="text-xs uppercase tracking-widest text-slate-400 font-bold ml-2">Nguyên Tác</label>
                    <textarea 
                      className="flex-1 bg-slate-900/60 border border-white/10 rounded-2xl p-4 outline-none focus:ring-2 ring-purple-500/20 resize-none font-serif text-lg leading-relaxed"
                      placeholder="Dán văn bản gốc vào đây..."
                      value={transInput}
                      onChange={(e) => setTransInput(e.target.value)}
                    />
                  </div>
                  <div className="flex flex-col gap-2 relative">
                    <label className="text-xs uppercase tracking-widest text-slate-400 font-bold ml-2">Bản Dịch Sola</label>
                    <div className="flex-1 bg-slate-900/80 border border-purple-500/30 rounded-2xl p-4 font-serif text-lg leading-relaxed overflow-y-auto whitespace-pre-wrap">
                      {loading ? (
                        <div className="flex flex-col items-center justify-center h-full gap-4 opacity-50">
                          <RefreshCw className="animate-spin text-purple-400" size={32} />
                          <p className="animate-pulse">Đang thi triển ma pháp...</p>
                        </div>
                      ) : transOutput || <span className="text-slate-600 italic">Kết quả sẽ hiện ra sau khi thi triển phép thuật...</span>}
                    </div>
                  </div>
                </div>

                <div className="flex justify-center">
                  <button 
                    onClick={handleTranslate}
                    disabled={loading || !transInput}
                    className="px-10 py-4 bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-500 hover:to-blue-500 disabled:opacity-50 rounded-full font-bold shadow-xl shadow-purple-500/20 flex items-center gap-3 transition-all active:scale-95"
                  >
                    <Wand2 size={20} /> Thi Triển Dịch Thuật
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* Tab 2: Thư Viện Cổ Thư */}
          {activeTab === 'library' && (
            <div className="h-full flex flex-col animate-in fade-in duration-500">
              <div className="flex justify-between items-end mb-6">
                <SectionHeader title="Thư Viện Cổ Thư" subtitle="Quản lý và dịch thuật các bộ truyện dài (EPUB/TXT)" />
                <div className="flex gap-2">
                   <button 
                    onClick={() => setIsParallelView(!isParallelView)} 
                    className={`px-4 py-2 rounded-lg border transition-all flex items-center gap-2 text-sm ${isParallelView ? 'bg-purple-600 border-purple-400' : 'bg-slate-800 border-white/10'}`}
                  >
                    {isParallelView ? <Eye size={16} /> : <EyeOff size={16} />} Song Song
                  </button>
                  <label className="cursor-pointer px-4 py-2 bg-blue-600 hover:bg-blue-500 rounded-lg flex items-center gap-2 text-sm font-medium transition-all">
                    <Upload size={16} /> Nạp Cổ Thư
                    <input type="file" className="hidden" accept=".epub,.txt" onChange={handleFileUpload} />
                  </label>
                </div>
              </div>

              {chapters.length > 0 ? (
                <div className="flex flex-1 gap-6 overflow-hidden">
                  {/* List Chương */}
                  <div className="w-64 bg-slate-900/60 border border-white/5 rounded-2xl p-2 overflow-y-auto custom-scrollbar">
                    {chapters.map((ch, idx) => (
                      <button 
                        key={idx}
                        onClick={() => setCurrentChapterIndex(idx)}
                        className={`w-full text-left p-3 rounded-xl mb-1 transition-all flex items-center justify-between group ${currentChapterIndex === idx ? 'bg-purple-600/30 text-purple-200 border border-purple-500/30' : 'hover:bg-white/5 text-slate-400'}`}
                      >
                        <span className="truncate text-sm">{ch.title}</span>
                        {ch.translated && <div className="w-2 h-2 bg-green-500 rounded-full" />}
                      </button>
                    ))}
                  </div>

                  {/* Nội dung Chương */}
                  <div className="flex-1 flex flex-col gap-4 overflow-hidden">
                    <div className="bg-slate-800/40 border border-white/10 rounded-2xl flex-1 flex overflow-hidden">
                      <div className={`p-6 overflow-y-auto custom-scrollbar border-r border-white/5 transition-all ${isParallelView ? 'w-1/2' : 'w-full'}`}>
                         <h3 className="text-xs font-bold text-slate-500 uppercase tracking-widest mb-4">Nguyên Tác</h3>
                         <div className="font-serif text-lg leading-loose">{chapters[currentChapterIndex]?.original}</div>
                      </div>
                      {isParallelView && (
                        <div className="w-1/2 p-6 overflow-y-auto custom-scrollbar bg-slate-950/30">
                           <h3 className="text-xs font-bold text-purple-400 uppercase tracking-widest mb-4">Bản Dịch</h3>
                           <div className="font-serif text-lg leading-loose">
                            {chapters[currentChapterIndex]?.translated || <span className="text-slate-600 italic">Chương này chưa được dịch...</span>}
                           </div>
                        </div>
                      )}
                    </div>
                    
                    <div className="flex justify-between items-center p-2">
                       <button className="text-slate-400 hover:text-white flex items-center gap-1"><Trash2 size={16}/> Xóa thư viện</button>
                       <div className="flex gap-3">
                         <button 
                          onClick={async () => {
                            const system = `Dịch chương truyện này sang tiếng Việt. Context: ${contextPrompt}`;
                            const res = await callGemini(chapters[currentChapterIndex].original, system);
                            if (res) {
                              const newChapters = [...chapters];
                              newChapters[currentChapterIndex].translated = res;
                              setChapters(newChapters);
                            }
                          }}
                          className="px-6 py-2 bg-purple-600 rounded-full font-bold text-sm flex items-center gap-2 hover:bg-purple-500"
                        >
                          <Play size={16} /> Dịch Chương Này
                         </button>
                       </div>
                    </div>
                  </div>
                </div>
              ) : (
                <div className="flex-1 flex flex-col items-center justify-center border-2 border-dashed border-white/10 rounded-3xl opacity-40">
                  <BookOpen size={64} className="mb-4" />
                  <p className="text-xl">Thư viện đang trống. Hãy nạp file .epub hoặc .txt</p>
                </div>
              )}
            </div>
          )}

          {/* Tab 3: Giải Mã Văn Chương */}
          {activeTab === 'analyze' && (
            <div className="max-w-4xl mx-auto animate-in zoom-in-95 duration-500">
              <SectionHeader title="Giải Mã Văn Chương" subtitle="Phân tích tầng sâu nghĩa cảnh và cảm xúc nhân vật" />
              <div className="bg-slate-800/40 border border-white/10 rounded-3xl p-6 flex flex-col gap-6">
                <textarea 
                  className="w-full h-40 bg-slate-950/50 border border-white/10 rounded-2xl p-4 outline-none focus:border-blue-500 transition-all font-serif italic text-lg"
                  placeholder="Nhập đoạn văn khó nhằn cần giải mã..."
                  value={analyzeInput}
                  onChange={(e) => setAnalyzeInput(e.target.value)}
                />
                <button 
                  onClick={handleAnalyze}
                  className="w-full py-4 bg-gradient-to-r from-blue-600 to-indigo-600 rounded-xl font-bold flex items-center justify-center gap-3"
                >
                  <ScrollText size={20} /> Giải Mã Ngay
                </button>
                {analyzeResult && (
                  <div className="bg-blue-900/20 border border-blue-500/30 rounded-2xl p-6 prose prose-invert max-w-none">
                    <h4 className="text-blue-400 font-bold mb-2 flex items-center gap-2"><Sparkles size={16}/> Kết quả phân tích</h4>
                    <div className="text-slate-300 leading-relaxed whitespace-pre-wrap">{analyzeResult}</div>
                  </div>
                )}
              </div>
            </div>
          )}

          {/* Tab 4: Hồ Thanh Tẩy */}
          {activeTab === 'purify' && (
            <div className="max-w-5xl mx-auto animate-in fade-in duration-500">
              <SectionHeader title="Hồ Thanh Tẩy" subtitle="Loại bỏ tạp chất, mã rác và văn bản thừa từ bản gốc" />
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div className="space-y-4">
                  <div className="flex justify-between items-center px-2">
                    <span className="text-sm font-bold text-slate-400 uppercase tracking-widest">Nạp Văn Bản Rác</span>
                    <button onClick={() => setCleanInput('')} className="text-xs text-red-400 hover:underline">Xóa sạch</button>
                  </div>
                  <textarea 
                    className="w-full h-[400px] bg-slate-900/60 border border-white/10 rounded-2xl p-4 outline-none focus:border-green-500 transition-all font-mono text-sm"
                    placeholder="Dán văn bản có lẫn HTML, ký tự lạ, link lậu..."
                    value={cleanInput}
                    onChange={(e) => setCleanInput(e.target.value)}
                  />
                  <div className="grid grid-cols-4 gap-2">
                    <PurifyBtn label="Tiếng Nhật" onClick={() => purifyText('JA')} color="bg-orange-600" />
                    <PurifyBtn label="Tiếng Trung" onClick={() => purifyText('ZH')} color="bg
